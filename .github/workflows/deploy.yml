name: Deploy Application

on:
  push:
    branches:
      - main
    paths:
      - "app/**"

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: strapi
  ECS_CLUSTER: namit-app-cluster
  ECS_SERVICE: namit-app-service
  CODEDEPLOY_APP: strapi-codedeploy-app
  CODEDEPLOY_GROUP: strapi-deployment-group
  CONTAINER_NAME: aman-strapi-container

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          docker build -t $IMAGE_URI ./app
          docker push $IMAGE_URI
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Get current task definition ARN
        run: |
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].taskDefinition' \
            --output text)

          echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition $TASK_DEF_ARN \
            --query 'taskDefinition' > task-def.json

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create new task definition revision
        run: |
          jq --arg IMAGE "$IMAGE_URI" \
             --arg NAME "$CONTAINER_NAME" \
             '{
                family,
                taskRoleArn,
                executionRoleArn,
                networkMode,
                containerDefinitions: (.containerDefinitions | map(
                  if .name == $NAME then .image = $IMAGE else . end
                )),
                volumes,
                requiresCompatibilities,
                cpu,
                memory
              }' \
             task-def.json > new-task-def.json

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "NEW_TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_ENV

      - name: Update appspec.json with new task definition
        run: |
          jq --arg TASK_DEF "$NEW_TASK_DEF_ARN" \
             '.Resources[0].TargetService.Properties.TaskDefinition = $TASK_DEF' \
             appspec.json > appspec-final.json

      - name: Trigger CodeDeploy deployment
        run: |
          APP_SPEC=$(cat appspec-final.json | jq -c .)

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name $CODEDEPLOY_APP \
            --deployment-group-name $CODEDEPLOY_GROUP \
            --revision revisionType=AppSpecContent,appSpecContent="{content='$APP_SPEC'}" \
            --query deploymentId \
            --output text)

          echo "Deployment started with ID: $DEPLOYMENT_ID"
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV

      - name: Wait for deployment to finish
        run: |
          aws deploy wait deployment-successful \
            --deployment-id $DEPLOYMENT_ID

      - name: Deployment successful
        run: echo "Blue/Green deployment completed successfully!"